// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// -------------------------------------------
//             Core Business Models
// -------------------------------------------

// Represents a master product, containing general, non-inventory information.
model Product {
  id          String @id @default(cuid())
  name        String
  description String?
  category    String
  brand       String
  units       Json   // e.g., { "baseUnit": "pcs", "derivedUnits": [{"name": "box", "conversionFactor": 12}] }

  isService Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation: A master product can have many batches
  batches ProductBatch[]

  // Relation: A product can be part of many discount configurations
  productDiscountConfigurations ProductDiscountConfiguration[]
}

// Represents a specific batch of a product, with its own stock, price, etc.
model ProductBatch {
  id              String  @id @default(cuid())
  productId       String
  batchNumber     String
  sellingPrice    Float
  costPrice       Float?
  quantity        Int // Initial quantity when added via GRN
  stock           Int // Current available stock
  barcode         String? @unique
  supplierId      String?
  addedDate       DateTime
  manufactureDate DateTime?
  expiryDate      DateTime?
  location        String?
  notes           String?

  // Batch-level default tax and discount
  tax          Float?
  taxtype      String?
  discount     Float?
  discountType String?

  // Relations
  product         Product          @relation(fields: [productId], references: [id], onDelete: Restrict)
  supplier        Supplier?        @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  transactionLine TransactionLine? // A batch can be in one or more transaction lines, but this models the back-relation from TransactionLine.

  // GRN item relation
  grnItem GoodsReceivedNoteItem?

  // Discount config relation
  batchDiscountConfigurations BatchDiscountConfiguration[]


  @@unique([productId, batchNumber])
}

// Manages information about suppliers
model Supplier {
  id            String   @id @default(cuid())
  name          String   @unique
  contactPerson String?
  phone         String?
  email         String?  @unique
  address       String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relation: A supplier can provide many product batches and have many GRNs
  productBatches      ProductBatch[]
  goodsReceivedNotes  GoodsReceivedNote[]
}

// Manages information about customers
model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String?  @unique
  email     String?  @unique
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation: A customer can have many transactions
  transactions Transaction[]
}

model Company {
  id                 String  @id @default(cuid())
  name               String  @unique
  address            String?
  phone              String?
  email              String? @unique
  registrationNumber String?
  taxNumber          String?
  logoUrl            String?
  isActive           Boolean @default(true)
}


// -------------------------------------------
//             Transaction Models
// -------------------------------------------

model Transaction {
  id                  String  @id
  transactionDate     DateTime
  subtotal            Float
  totalDiscountAmount Float
  finalTotal          Float
  totalItems          Int
  totalQuantity       Float
  status              String // completed, refund, pending
  campaignId          String
  isGiftReceipt       Boolean @default(false)
  paymentStatus       String  @default("pending") // pending, partial, paid
  customerId          String

  // For refunds
  originalTransactionId String?          @unique
  originalTransaction   Transaction?     @relation("Refunds", fields: [originalTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refundTransactions    Transaction[]    @relation("Refunds")

  // Relations
  customer         Customer              @relation(fields: [customerId], references: [id], onDelete: Restrict)
  payment          Payment?
  lines            TransactionLine[]
  appliedDiscounts AppliedDiscountLog[]
  salePayments     SalePayment[]
}

model TransactionLine {
  id                      String   @id @default(cuid())
  transactionId           String
  productBatchId          String?
  productName             String
  batchNumber             String?
  quantity                Float // Base unit quantity
  displayUnit             String
  displayQuantity         Float
  unitPrice               Float
  lineTotalBeforeDiscount Float
  lineDiscount            Float
  lineTotalAfterDiscount  Float
  customDiscountValue     Float?
  customDiscountType      String?
  customApplyFixedOnce    Boolean?
  createdAt               DateTime @default(now())

  // Relations
  transaction  Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productBatch ProductBatch? @relation(fields: [productBatchId], references: [id], onDelete: Restrict) // A transaction line is for a specific batch

  @@unique([transactionId, productBatchId])
}

model Payment {
  id                String   @id @default(cuid())
  transactionId     String   @unique
  paidAmount        Float
  paymentMethod     String // cash, card, online
  outstandingAmount Float
  isInstallment     Boolean
  createdAt         DateTime @default(now())

  // Relation
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model AppliedDiscountLog {
  id                      String   @id @default(cuid())
  transactionId           String
  discountCampaignName    String
  sourceRuleName          String
  totalCalculatedDiscount Float
  ruleType                String
  productIdAffected       String?
  batchIdAffected         String?
  appliedOnce             Boolean?
  createdAt               DateTime @default(now())

  // Relation
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}


// -------------------------------------------
//             Purchase Models
// -------------------------------------------

model GoodsReceivedNote {
  id              String   @id @default(cuid())
  grnNumber       String   @unique
  grnDate         DateTime
  supplierId      String
  invoiceNumber   String?
  totalAmount     Float
  paidAmount      Float @default(0)
  paymentMethod   String // e.g., cash, credit
  paymentStatus   String @default("pending") // pending, partial, paid
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  supplier Supplier                @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  items    GoodsReceivedNoteItem[]
  payments PurchasePayment[]
}

model GoodsReceivedNoteItem {
  id             String  @id @default(cuid())
  grnId          String
  productBatchId String  @unique // Each GRN item creates one unique batch
  quantity       Int
  costPrice      Float
  discount       Float   @default(0)
  tax            Float   @default(0)
  total          Float

  // Relations
  grn          GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  productBatch ProductBatch      @relation(fields: [productBatchId], references: [id], onDelete: Restrict)
}

model PurchasePayment {
  id                  String   @id @default(cuid())
  goodsReceivedNoteId String
  amount              Float
  paymentDate         DateTime
  paymentMethod       String // cash, card, cheque, online
  notes               String?
  createdAt           DateTime @default(now())

  // Relations
  grn GoodsReceivedNote @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
}

model SalePayment {
  id            String      @id @default(cuid())
  transactionId String
  amount        Float
  paymentDate   DateTime
  paymentMethod String // cash, card, cheque, online
  notes         String?
  createdAt     DateTime    @default(now())
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}


// -------------------------------------------
//             Discount Models
// -------------------------------------------

// A set of discount configurations, acting as a "campaign".
model DiscountSet {
  id                            String    @id @default(cuid())
  name                          String    @unique
  description                   String?
  isActive                      Boolean   @default(true)
  isDefault                     Boolean   @default(false)
  isOneTimePerTransaction       Boolean   @default(false)
  validFrom                     DateTime?
  validTo                       DateTime?
  createdAt                     DateTime  @default(now())
  updatedAt                     DateTime  @updatedAt

  // One-to-many relations
  productConfigurations ProductDiscountConfiguration[]
  batchConfigurations   BatchDiscountConfiguration[]
  buyGetRules           BuyGetRule[]

  // One-to-one optional relations to rule configurations
  globalCartPriceRuleJsonId                String?                      @unique
  globalCartPriceRuleJson                  SpecificDiscountRuleConfig?  @relation("DSC_GlobalCartPrice", fields: [globalCartPriceRuleJsonId], references: [id], onDelete: SetNull)
  
  globalCartQuantityRuleJsonId             String?                      @unique
  globalCartQuantityRuleJson               SpecificDiscountRuleConfig?  @relation("DSC_GlobalCartQuantity", fields: [globalCartQuantityRuleJsonId], references: [id], onDelete: SetNull)

  defaultLineItemValueRuleJsonId           String?                      @unique
  defaultLineItemValueRuleJson             SpecificDiscountRuleConfig?  @relation("DSC_DefaultLineItemValue", fields: [defaultLineItemValueRuleJsonId], references: [id], onDelete: SetNull)

  defaultLineItemQuantityRuleJsonId        String?                      @unique
  defaultLineItemQuantityRuleJson          SpecificDiscountRuleConfig?  @relation("DSC_DefaultLineItemQuantity", fields: [defaultLineItemQuantityRuleJsonId], references: [id], onDelete: SetNull)

  defaultSpecificQtyThresholdRuleJsonId    String?                      @unique
  defaultSpecificQtyThresholdRuleJson      SpecificDiscountRuleConfig?  @relation("DSC_DefaultSpecificQty", fields: [defaultSpecificQtyThresholdRuleJsonId], references: [id], onDelete: SetNull)

  defaultSpecificUnitPriceThresholdRuleJsonId String?                   @unique
  defaultSpecificUnitPriceThresholdRuleJson   SpecificDiscountRuleConfig? @relation("DSC_DefaultSpecificUnit", fields: [defaultSpecificUnitPriceThresholdRuleJsonId], references: [id], onDelete: SetNull)
}

// A generic rule configuration that can be linked to different entities.
model SpecificDiscountRuleConfig {
  id              String    @id @default(cuid())
  isEnabled       Boolean   @default(true)
  name            String
  type            String // 'percentage' or 'fixed'
  value           Float
  conditionMin    Float?
  conditionMax    Float?
  applyFixedOnce  Boolean?
  description     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Back-relations for one-to-one relationships
  discountSetGlobalCartPrice           DiscountSet? @relation("DSC_GlobalCartPrice")
  discountSetGlobalCartQuantity        DiscountSet? @relation("DSC_GlobalCartQuantity")
  discountSetDefaultLineItemValue      DiscountSet? @relation("DSC_DefaultLineItemValue")
  discountSetDefaultLineItemQuantity   DiscountSet? @relation("DSC_DefaultLineItemQuantity")
  discountSetDefaultSpecificQty        DiscountSet? @relation("DSC_DefaultSpecificQty")
  discountSetDefaultSpecificUnit       DiscountSet? @relation("DSC_DefaultSpecificUnit")
  
  productConfigLineItemValue     ProductDiscountConfiguration? @relation("PDC_LineItemValue")
  productConfigLineItemQuantity  ProductDiscountConfiguration? @relation("PDC_LineItemQuantity")
  productConfigSpecificQty       ProductDiscountConfiguration? @relation("PDC_SpecificQty")
  productConfigSpecificUnitPrice ProductDiscountConfiguration? @relation("PDC_SpecificUnitPrice")
}

// Links a DiscountSet to a specific Product with its own set of rules.
model ProductDiscountConfiguration {
  id                           String    @id @default(cuid())
  productId                    String
  discountSetId                String
  productNameAtConfiguration   String
  isActiveForProductInCampaign Boolean   @default(true)
  priority                     Int?

  // One-to-one optional relations to rule configurations
  lineItemValueRuleJsonId           String?                      @unique
  lineItemValueRuleJson             SpecificDiscountRuleConfig?  @relation("PDC_LineItemValue", fields: [lineItemValueRuleJsonId], references: [id], onDelete: SetNull)

  lineItemQuantityRuleJsonId        String?                      @unique
  lineItemQuantityRuleJson          SpecificDiscountRuleConfig?  @relation("PDC_LineItemQuantity", fields: [lineItemQuantityRuleJsonId], references: [id], onDelete: SetNull)

  specificQtyThresholdRuleJsonId    String?                      @unique
  specificQtyThresholdRuleJson      SpecificDiscountRuleConfig?  @relation("PDC_SpecificQty", fields: [specificQtyThresholdRuleJsonId], references: [id], onDelete: SetNull)

  specificUnitPriceThresholdRuleJsonId String?                   @unique
  specificUnitPriceThresholdRuleJson   SpecificDiscountRuleConfig? @relation("PDC_SpecificUnitPrice", fields: [specificUnitPriceThresholdRuleJsonId], references: [id], onDelete: SetNull)

  // Relations
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  discountSet DiscountSet @relation(fields: [discountSetId], references: [id], onDelete: Cascade)

  @@unique([productId, discountSetId, priority])
}

// Placeholder for Batch specific configurations if needed in the future
model BatchDiscountConfiguration {
  id                           String    @id @default(cuid())
  productBatchId               String
  discountSetId                String
  isActiveForBatchInCampaign   Boolean   @default(true)
  priority                     Int?
  // Relations
  productBatch ProductBatch @relation(fields: [productBatchId], references: [id], onDelete: Cascade)
  discountSet  DiscountSet  @relation(fields: [discountSetId], references: [id], onDelete: Cascade)

  @@unique([productBatchId, discountSetId, priority])
}

// Defines a Buy-X-Get-Y rule within a DiscountSet.
model BuyGetRule {
  id             String    @id @default(cuid())
  discountSetId  String
  name           String
  buyProductId   String
  buyQuantity    Int
  getProductId   String
  getQuantity    Int
  discountType   String // 'percentage', 'fixed', 'free'
  discountValue  Float
  isRepeatable   Boolean   @default(false)
  maxApplications Int?
  priority       Int?
  description    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relation
  discountSet DiscountSet @relation(fields: [discountSetId], references: [id], onDelete: Cascade)
}
