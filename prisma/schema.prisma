// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

model Product {
  id              String    @id @default(cuid())
  name            String
  productId       String?
  batchNumber     String?
  sellingPrice    Float
  costPrice       Float?
  quantity        Int
  stock           Int
  barcode         String?   @unique
  category        String?
  brand           String?
  supplierId      String?
  location        String?
  units           String // { "baseUnit": "pcs", "derivedUnits": [{ "name": "box", "conversionFactor": 12 }] }
  isService       Boolean   @default(false)
  isActive        Boolean   @default(true)
  defaultQuantity Int       @default(1)
  tax             Float?
  taxtype         String?
  defaultDiscount      Float?
  defaultDiscountType  String?
  manufactureDate DateTime?
  expiryDate      DateTime?
  minStockLevel   Int?
  maxStockLevel   Int?
  notes           String?
  status          String?
  addeDate        DateTime  @default(now())
  userId          String?
  companyId       String?
}

model Customer {
  id           String        @id @default(cuid())
  name         String
  phone        String?       @unique
  address      String?
  transactions Transaction[]
}

model Transaction {
  id                    String                @id
  transactionDate       DateTime
  subtotal              Float
  totalDiscountAmount   Float
  finalTotal            Float
  totalItems            Int
  totalQuantity         Float
  status                String
  campaignId            String?
  originalTransactionId String?               @unique
  isGiftReceipt         Boolean               @default(false)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  payment Payment?

  lines            TransactionLine[]
  appliedDiscounts AppliedDiscount[]

  originalTransaction Refund? @relation("OriginalTransaction")
  refundFor         Refund? @relation("RefundTransaction")
}

model Payment {
  id                String      @id @default(cuid())
  transactionId     String      @unique
  paidAmount        Float
  paymentMethod     String
  outstandingAmount Float
  isInstallment     Boolean
  transaction       Transaction @relation(fields: [transactionId], references: [id])
}

model TransactionLine {
  id                      String      @id @default(cuid())
  transactionId           String
  productId               String
  productName             String
  batchId                 String?
  batchNumber             String?
  quantity                Float
  displayUnit             String?
  displayQuantity         Float?
  unitPrice               Float
  lineTotalBeforeDiscount Float
  lineDiscount            Float
  lineTotalAfterDiscount  Float
  customDiscountValue     Float?
  customDiscountType      String?
  customApplyFixedOnce    Boolean?
  transaction             Transaction @relation(fields: [transactionId], references: [id])
}

model AppliedDiscount {
  id                      String  @id @default(cuid())
  transactionId           String
  discountCampaignName    String
  sourceRuleName          String
  totalCalculatedDiscount Float
  ruleType                String
  productIdAffected       String?
  batchIdAffected         String?
  appliedOnce             Boolean?
  transaction             Transaction @relation(fields: [transactionId], references: [id])
}

model Refund {
  id                      String      @id @default(cuid())
  originalTransactionId   String      @unique
  refundTransactionId     String      @unique
  originalTransaction     Transaction @relation("OriginalTransaction", fields: [originalTransactionId], references: [id])
  refundTransaction       Transaction @relation("RefundTransaction", fields: [refundTransactionId], references: [id])
  refundDate              DateTime    @default(now())
  reason                  String?
}
