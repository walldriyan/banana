// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==============================================================
// 
//                          MODELS
// 
// ==============================================================

model User {
  id            String       @id @default(cuid())
  name          String
  email         String?      @unique
  role          String
  permissions   Json
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  transactions  Transaction[]
}

model Company {
  id                  String   @id @default(cuid())
  name                String   @unique
  address             String?
  phone               String?
  email               String?  @unique
  registrationNumber  String?  @unique
  taxNumber           String?
  logoUrl             String?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model Customer {
  id            String       @id @default(cuid())
  name          String
  phone         String?      @unique
  email         String?      @unique
  address       String?
  transactions  Transaction[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model Supplier {
  id              String             @id @default(cuid())
  name            String             @unique
  contactPerson   String?
  phone           String?
  email           String?            @unique
  address         String?
  notes           String?
  productBatches  ProductBatch[]
  grns            GoodsReceivedNote[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

// Master product model
model Product {
  id          String         @id @default(cuid())
  name        String
  description String?
  category    String
  brand       String
  units       Json // { "baseUnit": "pcs", "derivedUnits": [{"name": "box", "conversionFactor": 12}] }
  isService   Boolean        @default(false)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  batches     ProductBatch[]
}

// Product batch with inventory and pricing details
model ProductBatch {
  id              String                 @id @default(cuid())
  product         Product                @relation(fields: [productId], references: [id])
  productId       String
  batchNumber     String
  sellingPrice    Float
  costPrice       Float?
  quantity        Int // Original quantity from GRN
  stock           Int // Current stock level
  barcode         String?                @unique
  supplier        Supplier?              @relation(fields: [supplierId], references: [id])
  supplierId      String?
  manufactureDate DateTime?
  expiryDate      DateTime?
  addedDate       DateTime               @default(now())
  location        String?
  notes           String?
  tax             Float?
  taxtype         String?
  discount        Float?
  discountType    String?
  transactionLines TransactionLine[]
  grnItems        GoodsReceivedNoteItem[]

  @@unique([productId, batchNumber])
}

// ==============================================================
// 
//                      TRANSACTIONAL MODELS
// 
// ==============================================================

model Transaction {
  id                    String              @id
  transactionDate       DateTime
  subtotal              Float
  totalDiscountAmount   Float
  finalTotal            Float
  totalItems            Int
  totalQuantity         Float
  status                String
  campaignId            String
  isGiftReceipt         Boolean?            @default(false)
  
  customer              Customer            @relation(fields: [customerId], references: [id])
  customerId            String
  
  user                  User?               @relation(fields: [userId], references: [id])
  userId                String?

  payment               TransactionPayment?
  lines                 TransactionLine[]
  appliedDiscounts      AppliedDiscount[]

  paymentStatus         String?             @default("pending") // pending, partial, paid
  salePayments          SalePayment[]

  // For refunds
  originalTransactionId String?             @unique
  originalTransaction   Transaction?        @relation("RefundToOriginal", fields: [originalTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refundTransactions    Transaction[]       @relation("RefundToOriginal")
}

model TransactionPayment {
  id                String      @id @default(cuid())
  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId     String      @unique
  paidAmount        Float
  paymentMethod     String
  outstandingAmount Float
  isInstallment     Boolean
}

model TransactionLine {
  id                       String        @id @default(cuid())
  transaction              Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId            String
  productBatch             ProductBatch  @relation(fields: [productBatchId], references: [id], onUpdate: NoAction, onDelete: Restrict)
  productBatchId           String
  productName              String
  batchNumber              String?
  quantity                 Float
  displayUnit              String
  displayQuantity          Float
  unitPrice                Float
  lineTotalBeforeDiscount  Float
  lineDiscount             Float
  lineTotalAfterDiscount   Float
  
  // To store custom discount state
  customDiscountValue      Float?
  customDiscountType       String?
  customApplyFixedOnce     Boolean?
}

model AppliedDiscount {
  id                       String      @id @default(cuid())
  transaction              Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId            String
  discountCampaignName     String
  sourceRuleName           String
  totalCalculatedDiscount  Float
  ruleType                 String
  productIdAffected        String?
  batchIdAffected          String?
  appliedOnce              Boolean?
}

// For Sales/Debtors
model SalePayment {
  id              String      @id @default(cuid())
  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId   String
  amount          Float
  paymentDate     DateTime
  paymentMethod   String
  notes           String?
  createdAt       DateTime    @default(now())
}

// For Purchases/Creditors
model GoodsReceivedNote {
  id              String                   @id @default(cuid())
  grnNumber       String                   @unique
  grnDate         DateTime
  supplier        Supplier                 @relation(fields: [supplierId], references: [id])
  supplierId      String
  invoiceNumber   String?
  totalAmount     Float
  paidAmount      Float                    @default(0)
  paymentMethod   String                   // e.g., 'cash', 'credit'
  paymentStatus   String                   @default("pending") // pending, partial, paid
  notes           String?
  items           GoodsReceivedNoteItem[]
  payments        PurchasePayment[]
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
}

model GoodsReceivedNoteItem {
  id              String            @id @default(cuid())
  grn             GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  grnId           String
  productBatch    ProductBatch      @relation(fields: [productBatchId], references: [id], onDelete: Cascade)
  productBatchId  String            @unique
  quantity        Int
  costPrice       Float
  discount        Float             @default(0)
  tax             Float             @default(0)
  total           Float
}

model PurchasePayment {
  id                  String            @id @default(cuid())
  grn                 GoodsReceivedNote @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
  goodsReceivedNoteId String
  amount              Float
  paymentDate         DateTime
  paymentMethod       String
  notes               String?
  createdAt           DateTime          @default(now())
}
