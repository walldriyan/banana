// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}


// --- Master Product Model ---
// Contains general information about a product, independent of stock or price.
model Product {
  id          String        @id @default(cuid())
  name        String        @unique // e.g., "Dell Inspiron 15 Laptop"
  description String?
  category    String
  brand       String
  units       Json // { "baseUnit": "pcs", "derivedUnits": [{"name": "box", "conversionFactor": 12}] }
  isService   Boolean       @default(false) // e.g., for repair services
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  batches     ProductBatch[] // A master product can have many batches
}

// --- Product Batch Model ---
// Represents a specific batch of a product with its own stock, price, etc.
model ProductBatch {
  id              String  @id @default(cuid())
  productId       String
  batchNumber     String
  sellingPrice    Float
  costPrice       Float?
  stock           Int
  quantity        Int // Initial quantity when added
  barcode         String? @unique
  addedDate       DateTime @default(now())
  
  // Batch-specific tax and discount overrides
  tax             Float?
  taxtype         String? // e.g., 'PERCENTAGE', 'FIXED'
  discount        Float?
  discountType    String? // e.g., 'PERCENTAGE', 'FIXED'

  // Foreign key for Supplier
  supplierId      String?
  
  // Optional metadata
  manufactureDate DateTime?
  expiryDate      DateTime?
  location        String?
  notes           String?

  product         Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier        Supplier?  @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  
  transactionLines TransactionLine[]

  // Opposite relation field for GoodsReceivedNoteItem
  goodsReceivedNoteItem GoodsReceivedNoteItem?

  @@unique([productId, batchNumber])
}

// --- Transaction Models ---

model Transaction {
  id                  String       @id
  transactionDate     DateTime
  subtotal            Float
  totalDiscountAmount Float
  finalTotal          Float
  totalItems          Int
  totalQuantity       Float
  status              String // "completed", "refund", "pending"
  campaignId          String
  isGiftReceipt       Boolean      @default(false)
  paymentStatus       String       @default("pending") // "pending", "partial", "paid"

  // For refunds
  originalTransactionId String?    @unique
  originalTransaction   Transaction? @relation("RefundHistory", fields: [originalTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refundTransactions    Transaction[] @relation("RefundHistory")
  
  // Relations
  customerId          String
  customer            Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  payment             TransactionPayment?
  lines               TransactionLine[]
  appliedDiscounts    AppliedDiscount[]
  salePayments        SalePayment[]
}

model TransactionLine {
  id                      String   @id @default(cuid())
  transactionId           String
  productBatchId          String? // Changed from productId to productBatchId
  productName             String
  batchNumber             String?
  quantity                Float // Base unit quantity
  displayUnit             String
  displayQuantity         Float
  unitPrice               Float
  lineTotalBeforeDiscount Float
  lineDiscount            Float
  lineTotalAfterDiscount  Float
  
  // For custom discount overrides
  customDiscountValue   Float?
  customDiscountType    String?
  customApplyFixedOnce  Boolean?

  // Relations
  transaction  Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productBatch ProductBatch? @relation(fields: [productBatchId], references: [id], onDelete: Restrict)
}

model TransactionPayment {
    id                  String      @id @default(cuid())
    transactionId       String      @unique
    paidAmount          Float
    paymentMethod       String
    outstandingAmount   Float
    isInstallment       Boolean
    transaction         Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model AppliedDiscount {
  id                      String   @id @default(cuid())
  transactionId           String
  discountCampaignName    String
  sourceRuleName          String
  totalCalculatedDiscount Float
  ruleType                String
  productIdAffected       String?
  batchIdAffected         String?
  appliedOnce             Boolean?
  transaction             Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model SalePayment {
  id              String      @id @default(cuid())
  transactionId   String
  amount          Float
  paymentDate     DateTime
  paymentMethod   String      // "cash", "card", etc.
  notes           String?
  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}


// --- People & Company Models ---

model Customer {
  id           String        @id @default(cuid())
  name         String
  phone        String?       @unique
  email        String?       @unique
  address      String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
  financialTransactions FinancialTransaction[]
}

model Supplier {
  id            String           @id @default(cuid())
  name          String           @unique
  contactPerson String?
  phone         String?
  email         String?
  address       String?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  productBatches ProductBatch[]
  grns          GoodsReceivedNote[]
  financialTransactions FinancialTransaction[]
}

model Company {
    id                  String        @id @default(cuid())
    name                String        @unique
    address             String?
    phone               String?
    email               String?
    registrationNumber  String?
    taxNumber           String?
    logoUrl             String?
    isActive            Boolean       @default(true)
    createdAt           DateTime      @default(now())
    updatedAt           DateTime      @updatedAt
    financialTransactions FinancialTransaction[]
}

// --- Purchase & Stock Models ---

model GoodsReceivedNote {
  id            String        @id @default(cuid())
  grnNumber     String        @unique
  grnDate       DateTime
  supplierId    String
  invoiceNumber String?
  totalAmount   Float
  paidAmount    Float         @default(0)
  paymentMethod String        // e.g., "cash", "credit"
  paymentStatus String        @default("pending") // "pending", "partial", "paid"
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  supplier      Supplier      @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  items         GoodsReceivedNoteItem[]
  payments      PurchasePayment[]
}

model GoodsReceivedNoteItem {
  id             String            @id @default(cuid())
  grnId          String
  productBatchId String            @unique
  quantity       Int
  costPrice      Float
  discount       Float
  tax            Float
  total          Float
  
  grn            GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  productBatch   ProductBatch      @relation(fields: [productBatchId], references: [id], onDelete: Restrict)
}

model PurchasePayment {
  id                  String      @id @default(cuid())
  goodsReceivedNoteId String
  amount              Float
  paymentDate         DateTime
  paymentMethod       String      // "cash", "card", "cheque", "online"
  notes               String?
  
  grn                 GoodsReceivedNote @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
}


// --- Discount Configuration Models ---

model DiscountSet {
  id                  String        @id @default(cuid())
  name                String        @unique
  description         String?
  isActive            Boolean       @default(true)
  isDefault           Boolean       @default(false)
  isOneTimePerTransaction Boolean   @default(false)
  validFrom           DateTime?
  validTo             DateTime?

  // Storing complex rule configs as JSON
  globalCartPriceRuleJson           Json?
  globalCartQuantityRuleJson        Json?
  defaultLineItemValueRuleJson      Json?
  defaultLineItemQuantityRuleJson   Json?
  defaultSpecificQtyThresholdRuleJson Json?
  defaultSpecificUnitPriceThresholdRuleJson Json?

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

// --- Financial Management Models ---

model FinancialTransaction {
  id          String      @id @default(cuid())
  date        DateTime
  type        String      // "INCOME" or "EXPENSE"
  amount      Float
  description String
  category    String      // This is now a simple string field

  // Relations to other models
  companyId   String
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Restrict)

  // Optional relations
  customerId  String?
  customer    Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)

  supplierId  String?
  supplier    Supplier?   @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}
