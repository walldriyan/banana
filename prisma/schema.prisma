// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Product {
  id                        String   @id @default(cuid())
  name                      String
  productId                 String   // General product identifier, NOT unique on its own.
  batchNumber               String
  sellingPrice              Float
  costPrice                 Float?
  quantity                  Int
  stock                     Int      @default(0) // Redundant but good for quick checks
  barcode                   String?  @unique
  category                  String?
  brand                     String?
  location                  String?
  units                     String // JSON string: { "baseUnit": "pcs", "derivedUnits": [{"name": "box", "conversionFactor": 12}] }
  isService                 Boolean  @default(false)
  isActive                  Boolean  @default(true)
  defaultQuantity           Int      @default(1)
  tax                       Float?
  taxtype                   String?
  defaultDiscount           Float?
  defaultDiscountType       String?
  manufactureDate           DateTime?
  expiryDate                DateTime?
  addeDate                  DateTime @default(now())
  minStockLevel             Int?
  maxStockLevel             Int?
  notes                     String?

  supplierId                String?
  supplier                  Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  
  transactionLines          TransactionLine[]
  GoodsReceivedNoteItem     GoodsReceivedNoteItem[]

  @@unique([productId, batchNumber], name: "productId_batchNumber")
}


model Supplier {
  id            String   @id @default(cuid())
  name          String   @unique
  contactPerson String?
  phone         String?
  email         String?  @unique
  address       String?
  notes         String?
  products      Product[]
  grns          GoodsReceivedNote[]
}


model Customer {
  id            String   @id @default(cuid())
  name          String
  phone         String?  @unique
  email         String?  @unique
  address       String?
  transactions  Transaction[]
}


model Transaction {
  id                      String   @id
  transactionDate         DateTime @default(now())
  subtotal                Float
  totalDiscountAmount     Float
  finalTotal              Float
  totalItems              Int
  totalQuantity           Float
  status                  String   // "completed", "refund", "pending"
  campaignId              String
  isGiftReceipt           Boolean?

  paymentStatus           String @default("pending") // "pending", "partial", "paid"

  customerId              String
  customer                Customer @relation(fields: [customerId], references: [id])
  
  payment                 TransactionPayment?

  originalTransactionId   String?  @unique
  originalTransaction     Transaction? @relation("RefundOriginal", fields: [originalTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refundTransactions      Transaction[] @relation("RefundOriginal")

  lines                   TransactionLine[]
  appliedDiscounts        AppliedDiscountLog[]

  // For debtor management
  salePayments            SalePayment[]
}

model TransactionPayment {
  id                String   @id @default(cuid())
  transactionId     String   @unique
  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  paidAmount        Float
  paymentMethod     String
  outstandingAmount Float
  isInstallment     Boolean
}

model TransactionLine {
  id                        String   @id @default(cuid())
  transactionId             String
  transaction               Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productId                 String
  product                   Product @relation(fields: [productId], references: [id])
  productName               String
  batchNumber               String?
  quantity                  Float
  displayUnit               String
  displayQuantity           Float
  unitPrice                 Float
  lineTotalBeforeDiscount   Float
  lineDiscount              Float
  lineTotalAfterDiscount    Float
  customDiscountValue       Float?
  customDiscountType        String?
  customApplyFixedOnce      Boolean?
}

model AppliedDiscountLog {
  id                        String   @id @default(cuid())
  transactionId             String
  transaction               Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  discountCampaignName      String
  sourceRuleName            String
  totalCalculatedDiscount   Float
  ruleType                  String
  productIdAffected         String?
  batchIdAffected           String?
  appliedOnce               Boolean?
}

model GoodsReceivedNote {
  id             String    @id @default(cuid())
  grnNumber      String    @unique
  grnDate        DateTime
  supplierId     String
  supplier       Supplier  @relation(fields: [supplierId], references: [id])
  invoiceNumber  String?
  items          GoodsReceivedNoteItem[]
  notes          String?
  totalAmount    Float
  paidAmount     Float     @default(0)
  paymentMethod  String // cash, card, cheque, credit
  paymentStatus  String    @default("pending") // "pending", "partial", "paid"
  
  // For creditor management
  payments       PurchasePayment[]
}

model GoodsReceivedNoteItem {
  id                    String   @id @default(cuid())
  goodsReceivedNoteId   String
  goodsReceivedNote     GoodsReceivedNote @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
  productId             String
  product               Product @relation(fields: [productId], references: [id])
  batchNumber           String
  quantity              Float
  costPrice             Float
  discount              Float
  tax                   Float
  total                 Float
}

// For Creditor Management
model PurchasePayment {
  id                    String   @id @default(cuid())
  goodsReceivedNoteId   String
  goodsReceivedNote     GoodsReceivedNote @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
  amount                Float
  paymentDate           DateTime
  paymentMethod         String
  notes                 String?
}

// For Debtor Management
model SalePayment {
  id                    String   @id @default(cuid())
  transactionId         String
  transaction           Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  amount                Float
  paymentDate           DateTime
  paymentMethod         String
  notes                 String?
}
