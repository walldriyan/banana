// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Product {
  id              String    @id @default(cuid())
  productId       String // General product ID, e.g., 't-shirt-01'
  name            String
  batchNumber     String?
  sellingPrice    Float
  costPrice       Float?
  quantity        Int
  stock           Int
  barcode         String?   @unique
  category        String?
  brand           String?
  supplierId      String?
  location        String?
  units           String // JSON string for { baseUnit: 'pcs', derivedUnits: [{ name: 'box', conversionFactor: 12 }] }
  isService       Boolean   @default(false)
  isActive        Boolean   @default(true)
  defaultQuantity Int       @default(1)
  tax             Float?
  taxtype         String? // "FIXED" or "PERCENTAGE"
  defaultDiscount Float?
  defaultDiscountType String? // "FIXED" or "PERCENTAGE"
  manufactureDate DateTime?
  expiryDate      DateTime?
  addeDate        DateTime  @default(now())
  minStockLevel   Int?
  maxStockLevel   Int?
  notes           String?
}

model Transaction {
  id                      String    @id @default(cuid())
  transactionDate         DateTime  @default(now())
  subtotal                Float
  totalDiscountAmount     Float
  finalTotal              Float
  totalItems              Int
  totalQuantity           Float
  status                  String // "completed", "refund", "pending"
  campaignId              String
  isGiftReceipt           Boolean?
  originalTransactionId   String?   @unique
  customerId              String
  
  customer                Customer  @relation(fields: [customerId], references: [id])
  payment                 Payment?
  lines                   TransactionLine[]
  appliedDiscounts        AppliedDiscountLog[]
  
  originalTransaction     Transaction? @relation("RefundToOriginal", fields: [originalTransactionId], references: [id])
  refundTransactions      Transaction[] @relation("RefundToOriginal")
}

model TransactionLine {
  id                        Int      @id @default(autoincrement())
  transactionId             String
  productId                 String
  productName               String
  batchId                   String?
  batchNumber               String?
  quantity                  Float
  displayUnit               String
  displayQuantity           Float
  unitPrice                 Float
  lineTotalBeforeDiscount   Float
  lineDiscount              Float
  lineTotalAfterDiscount    Float
  customDiscountValue       Float?
  customDiscountType        String?
  customApplyFixedOnce      Boolean?
  transaction               Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model Payment {
  id                Int      @id @default(autoincrement())
  transactionId     String   @unique
  paidAmount        Float
  paymentMethod     String
  outstandingAmount Float
  isInstallment     Boolean
  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model AppliedDiscountLog {
  id                      Int      @id @default(autoincrement())
  transactionId           String
  discountCampaignName    String
  sourceRuleName          String
  totalCalculatedDiscount Float
  ruleType                String
  productIdAffected       String?
  batchIdAffected         String?
  appliedOnce             Boolean?
  transaction             Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model Customer {
  id       String    @id @default(cuid())
  name     String
  phone    String?   @unique
  email    String?   @unique
  address  String?
  transactions Transaction[]
}

model Supplier {
  id             String    @id @default(cuid())
  name           String    @unique
  contactPerson  String?
  phone          String?
  email          String?   @unique
  address        String?
  notes          String?
}
