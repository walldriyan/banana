// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ---------------------------------
// Company & People
// ---------------------------------

model Company {
  id                 String  @id @default(cuid())
  name               String  @unique
  address            String?
  phone              String? @unique
  email              String? @unique
  registrationNumber String? @unique
  taxNumber          String? @unique
  logoUrl            String?
  isActive           Boolean @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Customer {
  id           String        @id @default(cuid())
  name         String
  phone        String?       @unique
  email        String?       @unique
  address      String?
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Supplier {
  id            String             @id @default(cuid())
  name          String             @unique
  contactPerson String?
  phone         String?            @unique
  email         String?            @unique
  address       String?
  notes         String?
  batches       ProductBatch[]
  purchases     GoodsReceivedNote[]
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}

// ---------------------------------
// Product & Inventory
// ---------------------------------

model Product {
  id          String         @id @default(cuid())
  name        String
  description String?
  category    String
  brand       String
  units       Json // e.g., { baseUnit: 'pcs', derivedUnits: [{ name: 'box', conversionFactor: 12 }] }
  isService   Boolean        @default(false)
  isActive    Boolean        @default(true)
  batches     ProductBatch[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model ProductBatch {
  id                      String                 @id @default(cuid())
  product                 Product                @relation(fields: [productId], references: [id])
  productId               String
  batchNumber             String
  sellingPrice            Float
  costPrice               Float?
  quantity                Int // Initial quantity when added
  stock                   Int // Current available stock
  barcode                 String?                @unique
  addedDate               DateTime               @default(now())
  manufactureDate         DateTime?
  expiryDate              DateTime?
  location                String?
  notes                   String?
  supplier                Supplier?              @relation(fields: [supplierId], references: [id])
  supplierId              String?
  tax                     Float?
  taxtype                 String? // PERCENTAGE or FIXED
  discount                Float?
  discountType            String? // PERCENTAGE or FIXED
  transactionLines        TransactionLine[]
  goodsReceivedNoteItems GoodsReceivedNoteItem[]

  @@unique([productId, batchNumber])
}

// ---------------------------------
// Transactions & Sales
// ---------------------------------

model Transaction {
  id                    String                @id
  transactionDate       DateTime
  subtotal              Float
  totalDiscountAmount   Float
  finalTotal            Float
  totalItems            Int
  totalQuantity         Float
  status                String // e.g., 'completed', 'refund', 'pending'
  campaignId            String
  isGiftReceipt         Boolean?
  paymentStatus         String? // e.g., 'pending', 'partial', 'paid'
  originalTransactionId String?               @unique
  originalTransaction   Transaction?          @relation("Refund", fields: [originalTransactionId], references: [id])
  refundTransactions    Transaction[]         @relation("Refund")
  customer              Customer              @relation(fields: [customerId], references: [id])
  customerId            String
  payment               Payment?
  lines                 TransactionLine[]
  appliedDiscounts      AppliedDiscountLog[]
  salePayments          SalePayment[]
}

model Payment {
  id                String      @id @default(cuid())
  transactionId     String      @unique
  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  paidAmount        Float
  paymentMethod     String
  outstandingAmount Float
  isInstallment     Boolean
}

model TransactionLine {
  id                       String        @id @default(cuid())
  transaction              Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId            String
  productBatch             ProductBatch  @relation(fields: [productBatchId], references: [id])
  productBatchId           String
  productName              String
  batchNumber              String?
  quantity                 Float
  displayUnit              String
  displayQuantity          Float
  unitPrice                Float
  lineTotalBeforeDiscount  Float
  lineDiscount             Float
  lineTotalAfterDiscount   Float
  customDiscountValue      Float?
  customDiscountType       String?
  customApplyFixedOnce     Boolean?
}

model AppliedDiscountLog {
  id                      String      @id @default(cuid())
  transaction             Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId           String
  discountCampaignName    String
  sourceRuleName          String
  totalCalculatedDiscount Float
  ruleType                String
  productIdAffected       String?
  batchIdAffected         String?
  appliedOnce             Boolean?
}

// ---------------------------------
// Purchases
// ---------------------------------

model GoodsReceivedNote {
  id             String                   @id @default(cuid())
  grnNumber      String                   @unique
  grnDate        DateTime
  supplier       Supplier                 @relation(fields: [supplierId], references: [id])
  supplierId     String
  invoiceNumber  String?
  totalAmount    Float
  paidAmount     Float                    @default(0)
  paymentMethod  String
  paymentStatus  String                   @default("pending") // 'pending', 'partial', 'paid'
  notes          String?
  items          GoodsReceivedNoteItem[]
  payments       PurchasePayment[]
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
}

model GoodsReceivedNoteItem {
  id             String            @id @default(cuid())
  grn            GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  grnId          String
  productBatch   ProductBatch      @relation(fields: [productBatchId], references: [id])
  productBatchId String            @unique // Each GRN item creates one unique batch
  quantity       Int
  costPrice      Float
  discount       Float
  tax            Float
  total          Float
}


// ---------------------------------
// Payments (Credit & Debit)
// ---------------------------------

model PurchasePayment {
  id                  String            @id @default(cuid())
  goodsReceivedNote   GoodsReceivedNote @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
  goodsReceivedNoteId String
  amount              Float
  paymentDate         DateTime
  paymentMethod       String
  notes               String?
  createdAt           DateTime          @default(now())
}

model SalePayment {
  id            String      @id @default(cuid())
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId String
  amount        Float
  paymentDate   DateTime
  paymentMethod String
  notes         String?
  createdAt     DateTime    @default(now())
}


// ---------------------------------
// Dynamic Discount Models
// ---------------------------------

model DiscountSet {
  id                                  String                         @id @default(cuid())
  name                                String                         @unique
  description                         String?
  isActive                            Boolean                        @default(true)
  isDefault                           Boolean                        @default(false)
  isOneTimePerTransaction             Boolean                        @default(false)
  validFrom                           DateTime?
  validTo                             DateTime?
  maxUsagePerCustomer                 Int?
  
  // JSON fields for simple rule configurations
  globalCartPriceRuleJson             Json?
  globalCartQuantityRuleJson          Json?
  defaultLineItemValueRuleJson        Json?
  defaultLineItemQuantityRuleJson     Json?
  defaultSpecificQtyThresholdRuleJson Json?
  defaultSpecificUnitPriceThresholdRuleJson Json?

  // One-to-many relations for more complex rule types
  productConfigurations               ProductDiscountConfiguration[]
  buyGetRules                         BuyGetRule[]
  
  createdAt                           DateTime                       @default(now())
  updatedAt                           DateTime                       @updatedAt
}

model ProductDiscountConfiguration {
  id                          String      @id @default(cuid())
  discountSet                 DiscountSet @relation(fields: [discountSetId], references: [id], onDelete: Cascade)
  discountSetId               String
  productId                   String // General product ID, not the batch ID
  productNameAtConfiguration  String
  isActiveForProductInCampaign Boolean     @default(true)
  priority                    Int?

  // JSON fields for simple rule configurations
  lineItemValueRuleJson             Json?
  lineItemQuantityRuleJson          Json?
  specificQtyThresholdRuleJson      Json?
  specificUnitPriceThresholdRuleJson Json?

  createdAt                   DateTime    @default(now())
  updatedAt                   DateTime    @updatedAt
}

model BuyGetRule {
  id              String      @id @default(cuid())
  discountSet     DiscountSet @relation(fields: [discountSetId], references: [id], onDelete: Cascade)
  discountSetId   String
  name            String
  buyProductId    String
  buyQuantity     Int
  getProductId    String
  getQuantity     Int
  discountType    String // 'percentage', 'fixed', 'free'
  discountValue   Float
  isRepeatable    Boolean     @default(false)
  maxApplications Int?
  priority        Int?
  description     String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}
