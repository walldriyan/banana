// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Product {
  id                      String                  @id @default(cuid())
  name                    String
  productId               String                  @unique // General product ID, e.g., "TSHIRT-01"
  barcode                 String?                 @unique
  batchNumber             String?
  sellingPrice            Float
  costPrice               Float?
  quantity                Int
  stock                   Int
  units                   Json
  isService               Boolean                 @default(false)
  isActive                Boolean                 @default(true)
  defaultQuantity         Int                     @default(1)
  category                String?
  brand                   String?
  location                String?
  notes                   String?
  tax                     Float?
  taxtype                 String?
  defaultDiscount         Float?
  defaultDiscountType     String?
  manufactureDate         DateTime?
  expiryDate              DateTime?
  addeDate                DateTime                @default(now())
  minStockLevel           Int?
  maxStockLevel           Int?
  supplierId              String?
  supplier                Supplier?               @relation(fields: [supplierId], references: [id])
  transactionLines        TransactionLine[]
  GoodsReceivedNoteItem   GoodsReceivedNoteItem[]

  @@index([name])
}

model Customer {
  id           String        @id @default(cuid())
  name         String
  phone        String?       @unique
  email        String?       @unique
  address      String?
  transactions Transaction[]

  @@index([name])
}

model Supplier {
  id              String                @id @default(cuid())
  name            String                @unique
  contactPerson   String?
  phone           String?
  email           String?
  address         String?
  notes           String?
  products        Product[]
  grns            GoodsReceivedNote[]

  @@index([name])
}

model Transaction {
  id                      String              @id
  transactionDate         DateTime
  subtotal                Float
  totalDiscountAmount     Float
  finalTotal              Float
  totalItems              Int
  totalQuantity           Float
  status                  String // "completed", "refund", "pending"
  campaignId              String
  isGiftReceipt           Boolean?
  paymentStatus           String // "pending", "partial", "paid"

  customerId              String
  customer                Customer            @relation(fields: [customerId], references: [id])
  
  payment                 Payment?
  lines                   TransactionLine[]
  appliedDiscounts        AppliedDiscount[]

  originalTransactionId   String?              @unique
  originalTransaction     Transaction?         @relation("RefundToOriginal", fields: [originalTransactionId], references: [id])
  refundTransactions      Transaction[]        @relation("RefundToOriginal")
  salePayments            SalePayment[]

  @@index([transactionDate])
}

model TransactionLine {
  id                        String      @id @default(cuid())
  productName               String
  batchNumber               String?
  quantity                  Float
  displayUnit               String
  displayQuantity           Float
  unitPrice                 Float
  lineTotalBeforeDiscount   Float
  lineDiscount              Float
  lineTotalAfterDiscount    Float
  customDiscountValue       Float?
  customDiscountType        String?
  customApplyFixedOnce      Boolean?

  transactionId             String
  transaction               Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  productId                 String
  product                   Product     @relation(fields: [productId], references: [id])
  
  // These fields were part of the original schema but seem redundant now.
  // Keeping them commented out for reference in case they are needed.
  // batchId                   String?
}

model Payment {
  id                String      @id @default(cuid())
  paidAmount        Float
  paymentMethod     String
  outstandingAmount Float
  isInstallment     Boolean
  transactionId     String      @unique
  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model AppliedDiscount {
  id                       String      @id @default(cuid())
  discountCampaignName     String
  sourceRuleName           String
  totalCalculatedDiscount  Float
  ruleType                 String
  productIdAffected        String?
  batchIdAffected          String?
  appliedOnce              Boolean?
  transactionId            String
  transaction              Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model GoodsReceivedNote {
  id            String                  @id @default(cuid())
  grnNumber     String                  @unique
  grnDate       DateTime
  invoiceNumber String?
  totalAmount   Float
  paidAmount    Float                   @default(0)
  paymentMethod String
  paymentStatus String                  @default("pending") // pending, partial, paid
  notes         String?

  supplierId    String
  supplier      Supplier                @relation(fields: [supplierId], references: [id])
  items         GoodsReceivedNoteItem[]
  payments      PurchasePayment[]
}

model GoodsReceivedNoteItem {
  id              String            @id @default(cuid())
  productId       String
  product         Product           @relation(fields: [productId], references: [id])
  batchNumber     String?
  quantity        Int
  costPrice       Float
  discount        Float
  tax             Float
  total           Float

  grnId           String
  grn             GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
}

model PurchasePayment {
  id                  String             @id @default(cuid())
  amount              Float
  paymentDate         DateTime
  paymentMethod       String // cash, card, cheque, online
  notes               String?
  goodsReceivedNoteId String
  goodsReceivedNote   GoodsReceivedNote  @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
}

model SalePayment {
  id            String      @id @default(cuid())
  amount        Float
  paymentDate   DateTime
  paymentMethod String      // cash, card, cheque, online
  notes         String?
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}
