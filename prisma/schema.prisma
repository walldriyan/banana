// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Product {
  id                    String    @id @default(cuid())
  name                  String
  productId             String
  batchNumber           String?
  sellingPrice          Float
  costPrice             Float?
  quantity              Int
  stock                 Int       @default(0) // New field for total stock
  barcode               String?   @unique
  category              String?
  brand                 String?
  supplierId            String?
  location              String?
  units                 String
  isService             Boolean   @default(false)
  isActive              Boolean   @default(true)
  defaultQuantity       Int       @default(1)
  tax                   Float?
  taxtype               String?
  defaultDiscount       Float?
  defaultDiscountType   String?
  manufactureDate       DateTime?
  expiryDate            DateTime?
  minStockLevel         Int?
  maxStockLevel         Int?
  addeDate              DateTime
  lastUpdate            DateTime?

  @@unique([productId, batchNumber])
}

model Customer {
  id           String        @id @default(cuid())
  name         String
  phone        String?       @unique
  email        String?       @unique
  address      String?
  transactions Transaction[]
}

model Supplier {
  id            String              @id @default(cuid())
  name          String              @unique
  contactPerson String?
  phone         String?             @unique
  email         String?             @unique
  address       String?
  notes         String?
  grns          GoodsReceivedNote[]
}

model Transaction {
  id                    String    @id
  transactionDate       DateTime
  subtotal              Float
  totalDiscountAmount   Float
  finalTotal            Float
  totalItems            Int
  totalQuantity         Float
  status                String // "completed", "refund", "pending"
  campaignId            String
  isGiftReceipt         Boolean?
  customerId            String
  customer              Customer  @relation(fields: [customerId], references: [id])
  payment               Payment?
  lines                 TransactionLine[]
  appliedDiscounts      AppliedDiscount[]

  // For refunds
  originalTransactionId String?             @unique
  originalTransaction   Transaction?        @relation("RefundToOriginal", fields: [originalTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refundTransactions    Transaction[]       @relation("RefundToOriginal")
}

model Payment {
  id                String      @id @default(cuid())
  paidAmount        Float
  paymentMethod     String // "cash", "card", "online"
  outstandingAmount Float
  isInstallment     Boolean
  transactionId     String      @unique
  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model TransactionLine {
  id                      String      @id @default(cuid())
  productId               String
  productName             String
  batchId                 String
  batchNumber             String?
  quantity                Float
  displayUnit             String
  displayQuantity         Float
  unitPrice               Float
  lineTotalBeforeDiscount Float
  lineDiscount            Float
  lineTotalAfterDiscount  Float
  customDiscountValue     Float?
  customDiscountType      String?
  customApplyFixedOnce    Boolean?
  transactionId           String
  transaction             Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model AppliedDiscount {
  id                      String      @id @default(cuid())
  discountCampaignName    String
  sourceRuleName          String
  totalCalculatedDiscount Float
  ruleType                String
  productIdAffected       String?
  batchIdAffected         String?
  appliedOnce             Boolean?
  transactionId           String
  transaction             Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model GoodsReceivedNote {
  id            String                  @id @default(cuid())
  grnNumber     String                  @unique
  grnDate       DateTime
  supplierId    String
  invoiceNumber String?
  notes         String?
  totalAmount   Float
  paidAmount    Float
  paymentMethod String // "cash", "card", "cheque", "credit"
  paymentStatus String // "pending", "partial", "paid"
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  supplier      Supplier                @relation(fields: [supplierId], references: [id])
  items         GoodsReceivedNoteItem[]
}

model GoodsReceivedNoteItem {
  id                  String            @id @default(cuid())
  goodsReceivedNoteId String
  productId           String
  batchNumber         String?
  quantity            Int
  costPrice           Float
  discount            Float
  tax                 Float
  total               Float
  grn                 GoodsReceivedNote @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
}
