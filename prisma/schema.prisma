// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

// --------------------------------------
// Core Models
// --------------------------------------

model Company {
  id                 String  @id @default(cuid())
  name               String  @unique
  address            String?
  phone              String? @unique
  email              String? @unique
  registrationNumber String? @unique
  taxNumber          String?
  logoUrl            String?
  isActive           Boolean @default(true)

  financialTransactions FinancialTransaction[]
}

model Supplier {
  id            String  @id @default(cuid())
  name          String  @unique
  contactPerson String?
  phone         String? @unique
  email         String? @unique
  address       String?
  notes         String?

  productBatches      ProductBatch[]
  goodsReceivedNotes  GoodsReceivedNote[]
  financialTransactions FinancialTransaction[]
}

model Customer {
  id       String  @id @default(cuid())
  name     String
  phone    String? @unique
  email    String? @unique
  address  String?

  transactions Transaction[]
  financialTransactions FinancialTransaction[]

  @@unique([name, phone])
}

// --------------------------------------
// Product & Inventory Models
// --------------------------------------

model Product {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  category    String
  brand       String
  units       Json
  isService   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  batches ProductBatch[]
}

model ProductBatch {
  id              String    @id @default(cuid())
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       String
  batchNumber     String
  sellingPrice    Float
  costPrice       Float?
  quantity        Int // Original quantity added
  stock           Int // Current available stock
  barcode         String?   @unique
  addedDate       DateTime  @default(now())
  manufactureDate DateTime?
  expiryDate      DateTime?
  location        String?
  notes           String?
  
  // Batch-level default tax and discount
  tax             Float?
  taxtype         String? // e.g., "PERCENTAGE", "FIXED"
  discount        Float?
  discountType    String? // e.g., "PERCENTAGE", "FIXED"

  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  supplierId      String?

  transactionLines    TransactionLine[]
  goodsReceivedNoteItems GoodsReceivedNoteItem[]

  @@unique([productId, batchNumber])
}

// --------------------------------------
// Transaction & Sales Models
// --------------------------------------

model Transaction {
  id                    String    @id
  transactionDate       DateTime  @default(now())
  subtotal              Float
  totalDiscountAmount   Float
  finalTotal            Float
  totalItems            Int
  totalQuantity         Float
  status                String // "completed", "refund", "pending"
  campaignId            String?
  isGiftReceipt         Boolean?  @default(false)
  paymentStatus         String?   @default("pending") // pending, partial, paid

  // Relation to Customer
  customer              Customer  @relation(fields: [customerId], references: [id])
  customerId            String

  // One-to-One relation to Payment
  payment               Payment?

  // One-to-Many relation to TransactionLine
  lines                 TransactionLine[]

  // One-to-Many relation to AppliedDiscount
  appliedDiscounts      AppliedDiscount[]

  // For refunds
  originalTransactionId String?          @unique
  originalTransaction   Transaction?     @relation("RefundToOriginal", fields: [originalTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refundTransactions    Transaction[]    @relation("RefundToOriginal")

  salePayments          SalePayment[]

  @@index([transactionDate])
}

model Payment {
  id                String      @id @default(cuid())
  paidAmount        Float
  paymentMethod     String
  outstandingAmount Float
  isInstallment     Boolean
  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId     String      @unique
}

model TransactionLine {
  id                      String       @id @default(cuid())
  transaction             Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId           String
  productBatch            ProductBatch @relation(fields: [productBatchId], references: [id])
  productBatchId          String
  productName             String
  batchNumber             String?
  quantity                Float
  displayUnit             String?
  displayQuantity         Float?
  unitPrice               Float
  lineTotalBeforeDiscount Float
  lineDiscount            Float
  lineTotalAfterDiscount  Float

  // Custom discount info
  customDiscountValue   Float?
  customDiscountType    String?
  customApplyFixedOnce  Boolean?
}

model AppliedDiscount {
  id                      String      @id @default(cuid())
  transaction             Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId           String
  discountCampaignName    String
  sourceRuleName          String
  totalCalculatedDiscount Float
  ruleType                String
  productIdAffected       String?
  batchIdAffected         String?
  appliedOnce             Boolean?
}

// --------------------------------------
// Purchase & GRN Models
// --------------------------------------

model GoodsReceivedNote {
  id             String    @id @default(cuid())
  grnNumber      String    @unique
  grnDate        DateTime
  invoiceNumber  String?
  totalAmount    Float
  paidAmount     Float     @default(0)
  paymentMethod  String?   // cash, card, cheque, credit
  paymentStatus  String?   @default("pending") // pending, partial, paid
  notes          String?

  supplier       Supplier  @relation(fields: [supplierId], references: [id])
  supplierId     String

  items          GoodsReceivedNoteItem[]
  payments       PurchasePayment[]
}

model GoodsReceivedNoteItem {
  id             String            @id @default(cuid())
  grn            GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  grnId          String
  productBatch   ProductBatch      @relation(fields: [productBatchId], references: [id])
  productBatchId String
  quantity       Int
  costPrice      Float
  discount       Float
  tax            Float
  total          Float
}

// --------------------------------------
// Payment Tracking Models
// --------------------------------------

model PurchasePayment {
  id                  String            @id @default(cuid())
  goodsReceivedNote   GoodsReceivedNote @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
  goodsReceivedNoteId String
  amount              Float
  paymentDate         DateTime
  paymentMethod       String // cash, card, cheque, online
  notes               String?
}

model SalePayment {
  id            String      @id @default(cuid())
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId String
  amount        Float
  paymentDate   DateTime
  paymentMethod String // cash, card, cheque, online
  notes         String?
}

// --------------------------------------
// Discount & Campaign Models
// --------------------------------------

model DiscountSet {
  id                                    String    @id @default(cuid())
  name                                  String    @unique
  description                           String?
  isActive                              Boolean   @default(true)
  isDefault                             Boolean   @default(false)
  isOneTimePerTransaction             Boolean   @default(false)
  validFrom                             DateTime?
  validTo                               DateTime?
  
  // Storing rules as JSON fields for simplicity and flexibility
  globalCartPriceRuleJson             Json?
  globalCartQuantityRuleJson          Json?
  defaultLineItemValueRuleJson        Json?
  defaultLineItemQuantityRuleJson     Json?
  defaultSpecificQtyThresholdRuleJson Json?
  defaultSpecificUnitPriceThresholdRuleJson Json?
}

// --------------------------------------
// FINANCIAL TRANSACTIONS (INCOME/EXPENSE)
// --------------------------------------

enum FinancialTransactionType {
  INCOME
  EXPENSE
}

model FinancialTransactionCategory {
  id            String   @id @default(cuid())
  name          String   @unique
  type          FinancialTransactionType // INCOME or EXPENSE
  description   String?
  createdAt     DateTime @default(now())
  
  transactions  FinancialTransaction[]
}

model FinancialTransaction {
  id            String   @id @default(cuid())
  date          DateTime
  type          FinancialTransactionType
  amount        Float
  description   String
  
  // Optional relations
  company       Company?  @relation(fields: [companyId], references: [id])
  companyId     String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  customerId    String?
  supplier      Supplier? @relation(fields: [supplierId], references: [id])
  supplierId    String?

  category      FinancialTransactionCategory @relation(fields: [categoryId], references: [id])
  categoryId    String
  
  // You might want to link this to a specific user who entered it
  // user User @relation(...)
  // userId String
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// NOTE: Models related to user authentication and roles might be handled separately
// or defined here if using a database adapter for NextAuth.
