// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Product {
  id                                 String                       @id @default(cuid())
  productId                          String
  name                               String
  batchNumber                        String?
  sellingPrice                       Float
  costPrice                          Float?
  quantity                           Int
  stock                              Int                          @default(0)
  barcode                            String?                      @unique
  category                           String?
  brand                              String?
  location                           String?
  notes                              String?
  supplierId                         String?
  minStockLevel                      Int?
  maxStockLevel                      Int?
  tax                                Float?
  taxtype                            String?
  defaultDiscount                    Float?
  defaultDiscountType                String?
  defaultQuantity                    Int                          @default(1)
  isActive                           Boolean                      @default(true)
  isService                          Boolean                      @default(false)
  units                              String
  manufactureDate                    DateTime?
  expiryDate                         DateTime?
  addeDate                           DateTime                     @default(now())
  transactionLines                   TransactionLine[]
  goodsReceivedNoteItems             GoodsReceivedNoteItem[]

  @@unique([productId, batchNumber])
  @@index([supplierId])
}

model Supplier {
  id                                 String                       @id @default(cuid())
  name                               String                       @unique
  contactPerson                      String?
  phone                              String?                      @unique
  email                              String?                      @unique
  address                            String?
  notes                              String?
  goodsReceivedNotes                 GoodsReceivedNote[]
}

model Customer {
  id                                 String                       @id @default_uuid
  name                               String
  phone                              String?                      @unique
  email                              String?                      @unique
  address                            String?
  transactions                       Transaction[]
}

model Transaction {
  id                                 String                       @id @default(cuid())
  transactionDate                    DateTime                     @default(now())
  subtotal                           Float
  totalDiscountAmount                Float
  finalTotal                         Float
  totalItems                         Int
  totalQuantity                      Float
  status                             String
  campaignId                         String
  isGiftReceipt                      Boolean?
  customerId                         String
  customer                           Customer                     @relation(fields: [customerId], references: [id])
  payment                            Payment?
  lines                              TransactionLine[]
  appliedDiscounts                   AppliedDiscount[]
  originalTransactionId              String?                      @unique
  originalTransaction                Transaction?                 @relation("Refund", fields: [originalTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refundTransactions                 Transaction[]                @relation("Refund")
}

model TransactionLine {
  id                                 String                       @id @default_cuid()
  transactionId                      String
  transaction                        Transaction                  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productId                          String
  product                            Product                      @relation(fields: [productId], references: [id])
  productName                        String
  batchId                            String?
  batchNumber                        String?
  quantity                           Float
  displayUnit                        String
  displayQuantity                    Float
  unitPrice                          Float
  lineTotalBeforeDiscount            Float
  lineDiscount                       Float
  lineTotalAfterDiscount             Float
  customDiscountValue                Float?
  customDiscountType                 String?
  customApplyFixedOnce               Boolean?
}

model Payment {
  id                                 String                       @id @default_cuid()
  transactionId                      String                       @unique
  transaction                        Transaction                  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  paidAmount                         Float
  paymentMethod                      String
  outstandingAmount                  Float
  isInstallment                      Boolean                      @default(false)
}

model AppliedDiscount {
  id                                 String                       @id @default_cuid()
  transactionId                      String
  transaction                        Transaction                  @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  discountCampaignName               String
  sourceRuleName                     String
  totalCalculatedDiscount            Float
  ruleType                           String
  productIdAffected                  String?
  batchIdAffected                    String?
  appliedOnce                        Boolean?
}

model GoodsReceivedNote {
  id                                 String                       @id @default_cuid()
  grnNumber                          String                       @unique
  grnDate                            DateTime
  supplierId                         String
  supplier                           Supplier                     @relation(fields: [supplierId], references: [id])
  invoiceNumber                      String?
  totalAmount                        Float
  paidAmount                         Float                        @default(0)
  paymentMethod                      String
  paymentStatus                      String                       @default("pending") // e.g., pending, partial, paid
  notes                              String?
  items                              GoodsReceivedNoteItem[]
  payments                           PurchasePayment[]
}

model GoodsReceivedNoteItem {
  id                                 String                       @id @default_cuid()
  goodsReceivedNoteId                String
  goodsReceivedNote                  GoodsReceivedNote            @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
  productId                          String
  product                            Product                      @relation(fields: [productId], references: [id])
  batchNumber                        String?
  quantity                           Int
  costPrice                          Float
  discount                           Float
  tax                                Float
  total                              Float
}

model PurchasePayment {
  id                                 String                       @id @default_cuid()
  goodsReceivedNoteId                String
  goodsReceivedNote                  GoodsReceivedNote            @relation(fields: [goodsReceivedNoteId], references: [id], onDelete: Cascade)
  amount                             Float
  paymentDate                        DateTime
  paymentMethod                      String // e.g., cash, card, cheque, online
  notes                              String?
}
