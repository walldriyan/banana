// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==============================================================
// Product and Stock Management Models
// ==============================================================

model Product {
  id                  String      @id @default(cuid())
  name                String
  productId           String // General product ID, not unique for batches
  batchNumber         String? // Batch specific number
  sellingPrice        Float
  costPrice           Float?
  quantity            Int
  stock               Int       @default(0) // New field for live stock tracking
  barcode             String?
  category            String?
  brand               String?
  supplierId          String?
  location            String?
  units               Json
  isService           Boolean   @default(false)
  isActive            Boolean   @default(true)
  defaultQuantity     Int       @default(1)
  tax                 Float?
  taxtype             String?
  defaultDiscount     Float?
  defaultDiscountType String?
  manufactureDate     DateTime?
  expiryDate          DateTime?
  minStockLevel       Int?
  maxStockLevel       Int?
  addeDate            DateTime  @default(now())
  notes               String?

  @@unique([productId, batchNumber]) // Combination of product ID and batch number should be unique
}

model Supplier {
  id            String   @id @default(cuid())
  name          String
  contactPerson String?
  phone         String?  @unique
  email         String?  @unique
  address       String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  grns          GoodsReceivedNote[]
}

model Customer {
  id          String        @id @default(cuid())
  name        String
  phone       String?       @unique
  email       String?       @unique
  address     String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  transactions Transaction[]
}

// ==============================================================
// Transaction and Payment Models
// ==============================================================

model Transaction {
  id                  String        @id @default(cuid())
  transactionDate     DateTime
  subtotal            Float
  totalDiscountAmount Float
  finalTotal          Float
  totalItems          Int
  totalQuantity       Float
  status              String // e.g., 'completed', 'refund', 'pending'
  campaignId          String
  isGiftReceipt       Boolean?

  customer            Customer      @relation(fields: [customerId], references: [id])
  customerId          String
  payment             Payment?
  lines               TransactionLine[]
  appliedDiscounts    AppliedDiscount[]

  // For refunds
  originalTransactionId String?       @unique
  originalTransaction   Transaction?    @relation("RefundToOriginal", fields: [originalTransactionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refundTransactions    Transaction[]   @relation("RefundToOriginal")

  createdAt           DateTime      @default(now())
}

model TransactionLine {
  id                      String      @id @default(cuid())
  productId               String
  productName             String
  batchId                 String // This will be the unique ID from the Product table
  batchNumber             String?
  quantity                Float
  displayUnit             String
  displayQuantity         Float
  unitPrice               Float
  lineTotalBeforeDiscount Float
  lineDiscount            Float
  lineTotalAfterDiscount  Float
  customDiscountValue     Float?
  customDiscountType      String?
  customApplyFixedOnce    Boolean?

  transaction             Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId           String
}

model Payment {
  id                String      @id @default(cuid())
  paidAmount        Float
  paymentMethod     String
  outstandingAmount Float
  isInstallment     Boolean

  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId     String      @unique
}

// ==============================================================
// Discount and GRN Models
// ==============================================================

model AppliedDiscount {
  id                      String      @id @default(cuid())
  discountCampaignName    String
  sourceRuleName          String
  totalCalculatedDiscount Float
  ruleType                String
  productIdAffected       String?
  batchIdAffected         String?
  appliedOnce             Boolean?

  transaction             Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId           String
}

model GoodsReceivedNote {
  id            String   @id @default(cuid())
  grnNumber     String   @unique
  grnDate       DateTime
  invoiceNumber String?
  totalAmount   Float
  paidAmount    Float
  paymentMethod String
  paymentStatus String // e.g., 'pending', 'partial', 'paid'
  notes         String?
  
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  supplierId    String

  items         GoodsReceivedNoteItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model GoodsReceivedNoteItem {
  id          String   @id @default(cuid())
  productId   String
  batchNumber String?
  quantity    Float
  costPrice   Float
  discount    Float
  tax         Float
  total       Float

  grn         GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  grnId       String
}
